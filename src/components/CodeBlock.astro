---
interface Props {
  code: string
  language?: string
  filename?: string
  highlights?: number[]
  showLineNumbers?: boolean
  class?: string
}

const {
  code,
  language = 'bash',
  filename,
  highlights = [],
  showLineNumbers = false,
  class: className = ''
} = Astro.props

const lines = code.trim().split('\n')
---

<div class={`code-block relative group ${className}`}>
  <!-- Subtle glow -->
  <div class="absolute -inset-1 bg-gradient-to-r from-lavender/10 via-buoy/5 to-lavender/10 rounded-lg blur opacity-0 group-hover:opacity-100 transition-opacity"></div>

  <div class="relative bg-navy border border-navy-light/30 rounded-lg overflow-hidden">
    {filename && (
      <div class="flex items-center justify-between px-4 py-2 bg-navy-dark border-b border-navy-light/20">
        <span class="text-xs text-slate font-mono">{filename}</span>
        <button
          class="copy-btn text-slate hover:text-buoy transition-colors p-1"
          data-code={code}
          aria-label="Copy code"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
        </button>
      </div>
    )}

    <pre class="p-4 overflow-x-auto text-sm"><code class={`language-${language}`}>{lines.map((line, i) => {
      const isHighlighted = highlights.includes(i + 1)
      const lineNum = showLineNumbers ? `<span class="text-slate-dark select-none mr-4 w-6 inline-block text-right">${i + 1}</span>` : ''
      return `<div class="${isHighlighted ? 'bg-buoy/10 -mx-4 px-4' : ''}">${lineNum}${line}</div>`
    }).join('')}</code></pre>
  </div>
</div>

<script>
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const code = btn.getAttribute('data-code')
      if (code) {
        await navigator.clipboard.writeText(code)
        btn.innerHTML = `<svg class="w-4 h-4 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`
        setTimeout(() => {
          btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`
        }, 2000)
      }
    })
  })
</script>
